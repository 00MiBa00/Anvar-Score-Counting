org, repo = (ENV["GITHUB_REPOSITORY"] || "").split("/")
match_org, match_repo = (ENV["MATCH_REPOSITORY"] || "").split("/")

# –ó–∞–¥–µ—Ä–∂–∫–∞ –æ–∂–∏–¥–∞–Ω–∏—è Podfile
def wait_for_podfile(timeout: 120)
  podfile_path = "#{ENV['IOS_BUILD_PATH']}/iOS/Podfile"
  waited = 0
  until File.exist?(podfile_path) || waited >= timeout
    sleep 1
    waited += 1
  end
  if File.exist?(podfile_path)
    UI.message("‚úÖ Podfile –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ #{waited} —Å–µ–∫—É–Ω–¥")
    true
  else
    UI.important("‚ö†Ô∏è Podfile –Ω–µ –Ω–∞–π–¥–µ–Ω –∑–∞ #{timeout} —Å–µ–∫—É–Ω–¥")
    false
  end
end

platform :ios do

  desc "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤"
  lane :sync_certificates do
    app_store_connect_api_key(
      key_id: ENV["APPSTORE_KEY_ID"],
      issuer_id: ENV["APPSTORE_ISSUER_ID"],
      key_content: ENV['APPSTORE_P8']
    )

    match(
      type: "appstore",
      storage_mode: "git",
      git_url: "git@github.com:#{match_org}/#{match_repo}.git",
      app_identifier: [
        ENV["IOS_BUNDLE_ID"],
        "#{ENV["IOS_BUNDLE_ID"]}.notifications"
      ],
      readonly: false
    )
  end

  desc "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å CocoaPods"
  lane :install_pods do
    cocoapods(
      clean: true,
      use_bundle_exec: false,
      repo_update: true,
      podfile: "#{ENV['IOS_BUILD_PATH']}/iOS/Podfile"
    )
  end

  desc "–°–æ–∑–¥–∞–Ω–∏–µ —Å–±–æ—Ä–∫–∏ –∏ .ipa"
  lane :build do
    begin
      setup_ci
      sync_certificates

      update_code_signing_settings(
        use_automatic_signing: true,
        path: "#{ENV['IOS_BUILD_PATH']}/iOS/Unity-iPhone.xcodeproj"
      )

      update_code_signing_settings(
        use_automatic_signing: false,
        team_id: ENV["sigh_#{ENV['IOS_BUNDLE_ID']}_appstore_team-id"],
        code_sign_identity: 'iPhone Distribution',
        targets: 'Unity-iPhone',
        path: "#{ENV['IOS_BUILD_PATH']}/iOS/Unity-iPhone.xcodeproj",
        profile_name: ENV["sigh_#{ENV['IOS_BUNDLE_ID']}_appstore_profile-name"],
        profile_uuid: ENV["sigh_#{ENV['IOS_BUNDLE_ID']}_appstore"]
      )

      update_code_signing_settings(
        use_automatic_signing: false,
        team_id: ENV["sigh_#{ENV['IOS_BUNDLE_ID']}.notifications_appstore_team-id"],
        code_sign_identity: 'iPhone Distribution',
        targets: 'notifications',
        path: "#{ENV['IOS_BUILD_PATH']}/iOS/Unity-iPhone.xcodeproj",
        profile_name: ENV["sigh_#{ENV['IOS_BUNDLE_ID']}.notifications_appstore_profile-name"],
        profile_uuid: ENV["sigh_#{ENV['IOS_BUNDLE_ID']}.notifications_appstore"]
      )

      version_number = ENV['APP_VERSION'] || '1.0.0'
      increment_version_number(version_number: version_number, xcodeproj: "#{ENV['IOS_BUILD_PATH']}/iOS/Unity-iPhone.xcodeproj")
      increment_build_number({
        build_number: latest_testflight_build_number(version: version_number, app_identifier: ENV['IOS_BUNDLE_ID']) + 1,
        xcodeproj: "#{ENV['IOS_BUILD_PATH']}/iOS/Unity-iPhone.xcodeproj"
      })

      UI.message("üì° –ñ–¥—ë–º Podfile: #{ENV['IOS_BUILD_PATH']}/iOS/Podfile")
      sh("ls -la #{ENV['IOS_BUILD_PATH']}/iOS || echo '‚ùå –ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'")

      if wait_for_podfile
        install_pods
      else
        UI.user_error!("üö´ Podfile –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–ª–¥–∞")
      end

      update_info_plist(
        xcodeproj: "#{ENV['IOS_BUILD_PATH']}/iOS/Unity-iPhone.xcodeproj",
        plist_path: 'Info.plist',
        block: proc do |plist|
          plist['ITSAppUsesNonExemptEncryption'] = false
          plist['MinimumOSVersion'] = '11.0'
          plist['NSLocationWhenInUseUsageDescription'] = 'Allow access to location for app usage'
        end
      )

      build_app(
        workspace: "#{ENV['IOS_BUILD_PATH']}/iOS/Unity-iPhone.xcworkspace",
        scheme: 'Unity-iPhone',
        xcargs: '-allowProvisioningUpdates',
        export_options: {
          method: 'app-store',
          uploadBitcode: false,
          compileBitcode: false,
          provisioningProfiles: {
            "#{ENV['IOS_BUNDLE_ID']}" => ENV["sigh_#{ENV['IOS_BUNDLE_ID']}_appstore_profile-name"],
            "#{ENV['IOS_BUNDLE_ID']}.notifications" => ENV["sigh_#{ENV['IOS_BUNDLE_ID']}.notifications_appstore_profile-name"]
          }
        }
      )

    rescue => ex
      UI.error("‚ùå –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π: #{ex}")
      sh("cat ~/Library/Logs/gym/ScoreCounting-Unity-iPhone.log || echo 'Log not found'")
      raise ex
    end
  end

  desc "–ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–ª–¥–∞ –≤ TestFlight"
  lane :beta do
    build
    upload_to_testflight(skip_waiting_for_build_processing: true)
  end

  desc "–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ª–∏–∑–∞ –≤ App Store"
  lane :release do
    build
    deliver
    upload_to_app_store(
      submit_for_review: false,
      automatic_release: false,
      force: true,
      skip_screenshots: true,
      run_precheck_before_submit: false
    )
  end

end
